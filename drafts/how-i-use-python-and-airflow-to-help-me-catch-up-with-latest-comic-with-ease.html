<!DOCTYPE html>
<!--[if lt IE 9 ]><html class="no-js oldie" lang="zh-hant-tw"> <![endif]-->
<!--[if IE 9 ]><html class="no-js oldie ie9" lang="zh-hant-tw"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<html class="no-js" lang="zh-hant-tw">
<!--<![endif]-->

<head>

    <!--- basic page needs
    ================================================== -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="author" content="Lee Meng" />
<title>LeeMeng - 如何用 Python 追漫畫連載 - Airflow 從零到專精之路</title>
    <!--- article-specific meta data
    ================================================== -->
        <meta name="description" content="Airflow 是一個以 Python 開發的工作流管理系統，也是資料工程不可或缺的利器之一。近年不管是資料科學家、資料工程師還是任何需要處理數據的軟體工程師，Airflow 都是他們用來建構 ETL 以及處理批量資料的首選之一。這篇文章希望以一個簡易的漫畫連載通知 App 作為引子，讓讀者直觀地了解 Airflow 背後的運作原理、建立資料工程的知識基礎，並在閱讀本文後發揮自己的創意，實際應用 Airflow 來解決並自動化自己及企業的數據問題。" />
        <meta name="keywords" content="Python, Airflow, 資料工程, Selenium, Slack" />
        <meta name="tags" content="Python" />
        <meta name="tags" content="Airflow" />
        <meta name="tags" content="資料工程" />
        <meta name="tags" content="Selenium" />
        <meta name="tags" content="Slack" />


    <!--- Open Graph Object metas
    ================================================== -->
        <meta property="og:image" content="https://leemengtaiwan.github.io/theme/images/background/raj-eiamworakul-603747-unsplash.jpg" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://leemengtaiwan.github.io/drafts/how-i-use-python-and-airflow-to-help-me-catch-up-with-latest-comic-with-ease.html" />
        <meta property="og:title" content="如何用 Python 追漫畫連載 - Airflow 從零到專精之路" />
        <meta property="og:description" content="Airflow 是一個以 Python 開發的工作流管理系統，也是資料工程不可或缺的利器之一。近年不管是資料科學家、資料工程師還是任何需要處理數據的軟體工程師，Airflow 都是他們用來建構 ETL 以及處理批量資料的首選之一。這篇文章希望以一個簡易的漫畫連載通知 App 作為引子，讓讀者直觀地了解 Airflow 背後的運作原理、建立資料工程的知識基礎，並在閱讀本文後發揮自己的創意，實際應用 Airflow 來解決並自動化自己及企業的數據問題。" />

    <!-- mobile specific metas
    ================================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS
    ================================================== -->
    <!--for customized css in individual page-->
        <link rel="stylesheet" type="text/css" href="https://leemengtaiwan.github.io/theme/css/bootstrap.min.css">

    <!--for showing toc navigation which slide in from left-->
        <link rel="stylesheet" type="text/css" href="https://leemengtaiwan.github.io/theme/css/toc-nav.css">

    <link rel="stylesheet" type="text/css" href="https://leemengtaiwan.github.io/theme/css/base.css">
    <link rel="stylesheet" type="text/css" href="https://leemengtaiwan.github.io/theme/css/vendor.css">
    <link rel="stylesheet" type="text/css" href="https://leemengtaiwan.github.io/theme/css/main.css">
    <link rel="stylesheet" type="text/css" href="https://leemengtaiwan.github.io/theme/css/ipython.css">
    <link rel="stylesheet" type="text/css" href='https://leemengtaiwan.github.io/theme/css/progress-bar.css' />



    <!--TiqueSearch-->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400">
    <link rel="stylesheet" href="https://leemengtaiwan.github.io/theme/tipuesearch/css/normalize.css">
    <link rel="stylesheet" href="https://leemengtaiwan.github.io/theme/tipuesearch/css/tipuesearch.css">

    <!-- script
    ================================================== -->
    <script src="https://leemengtaiwan.github.io/theme/js/modernizr.js"></script>
    <script src="https://leemengtaiwan.github.io/theme/js/pace.min.js"></script>

    <!-- favicons
    ================================================== -->
    <link rel="shortcut icon" href="../theme/images/favicon.ico" type="image/x-icon"/>
    <link rel="icon" href="../theme/images/favicon.ico" type="image/x-icon"/>

<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-106559980-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-106559980-1');
</script>



</head>


<body id="top">

    <!-- header
    ================================================== -->
    <header class="s-header">

        <div class="header-logo">
            <a class="site-logo" href="../index.html"><img src="https://leemengtaiwan.github.io/theme/images/logo.png" alt="Homepage"></a>
        </div>
<!--navigation bar ref: http://jinja.pocoo.org/docs/2.10/tricks/-->



<nav class="header-nav-wrap">
    <ul class="header-nav">
        <li>
            <a href="../index.html#home">Home</a>
        </li>
        <li>
            <a href="../index.html#about">About</a>
        </li>
        <li class="current">
            <a href="../blog.html">Blog</a>
        </li>
        <li>
            <a href="../index.html#contact">Contact</a>
        </li>

    </ul>

    <!--<div class="search-container">-->
        <!--<form action="../search.html">-->
            <!--<input type="text" placeholder="Search.." name="search">-->
            <!--<button type="submit"><i class="im im-magnifier" aria-hidden="true"></i></button>-->
        <!--</form>-->
    <!--</div>-->

</nav>
        <a class="header-menu-toggle" href="#0"><span>Menu</span></a>

    </header> <!-- end s-header -->



    <!--TOC navigation displayed when clicked from left-navigation button-->
    <div id="tocNav" class="overlay" onclick="closeTocNav()">
      <div class="overlay-content">
        <div id="toc"><ul><li><a class="toc-href" href="#" title="如何用 Python 追漫畫連載 - Airflow 從零到專精之路">如何用 Python 追漫畫連載 - Airflow 從零到專精之路</a><ul><li><a class="toc-href" href="#追連載：一個-Airflow-的輕鬆使用案例" title="追連載：一個 Airflow 的輕鬆使用案例">追連載：一個 Airflow 的輕鬆使用案例</a></li><li><a class="toc-href" href="#章節傳送門" title="章節傳送門">章節傳送門</a></li><li><a class="toc-href" href="#所以為何要這-App-？" title="所以為何要這 App ？">所以為何要這 App ？</a></li><li><a class="toc-href" href="#工作流概念-&amp;-Airflow" title="工作流概念 &amp; Airflow">工作流概念 &amp; Airflow</a></li><li><a class="toc-href" href="#Python-&amp;-Airflow-實作" title="Python &amp; Airflow 實作">Python &amp; Airflow 實作</a><ul><li><a class="toc-href" href="#建置-Airflow-環境" title="建置 Airflow 環境">建置 Airflow 環境</a></li><li><a class="toc-href" href="#Airflow-基本概念" title="Airflow 基本概念">Airflow 基本概念</a></li><li><a class="toc-href" href="#App-版本一：大鍋炒" title="App 版本一：大鍋炒">App 版本一：大鍋炒</a><ul><li><a class="toc-href" href="#輕鬆排程" title="輕鬆排程">輕鬆排程</a></li><li><a class="toc-href" href="#Operator：將實作邏輯跟-DAG-排程分離" title="Operator：將實作邏輯跟 DAG 排程分離">Operator：將實作邏輯跟 DAG 排程分離</a></li><li><a class="toc-href" href="#測試開發-Airflow-工作" title="測試開發 Airflow 工作">測試開發 Airflow 工作</a></li></ul></li><li><a class="toc-href" href="#App-版本二：模組化_1" title="App 版本二：模組化">App 版本二：模組化</a><ul><li><a class="toc-href" href="#Airflow-排程器" title="Airflow 排程器">Airflow 排程器</a></li><li><a class="toc-href" href="#手動觸發-DAG" title="手動觸發 DAG">手動觸發 DAG</a></li><li><a class="toc-href" href="#定義工作流程" title="定義工作流程">定義工作流程</a></li><li><a class="toc-href" href="#Airflow-變數以及-Jinja-模板" title="Airflow 變數以及 Jinja 模板">Airflow 變數以及 Jinja 模板</a></li><li><a class="toc-href" href="#執行時間：排程最重要的概念" title="執行時間：排程最重要的概念">執行時間：排程最重要的概念</a></li><li><a class="toc-href" href="#正式排程" title="正式排程">正式排程</a></li></ul></li><li><a class="toc-href" href="#App-版本三：填填樂_1" title="App 版本三：填填樂">App 版本三：填填樂</a><ul><li><a class="toc-href" href="#自動化的核心：Selenium" title="自動化的核心：Selenium">自動化的核心：Selenium</a></li><li><a class="toc-href" href="#工作之間的訊息交換" title="工作之間的訊息交換">工作之間的訊息交換</a></li><li><a class="toc-href" href="#實作一個閱讀紀錄" title="實作一個閱讀紀錄">實作一個閱讀紀錄</a></li></ul></li></ul></li><li><a class="toc-href" href="#為何要-Airflow？_2" title="為何要 Airflow？">為何要 Airflow？</a></li><li><a class="toc-href" href="#結語" title="結語">結語</a></li><li><a class="toc-href" href="#繼續探索-/-前往專精之路" title="繼續探索 / 前往專精之路">繼續探索 / 前往專精之路</a></li></ul></li></ul></div>
      </div>
    </div>


    <article class="blog-single">

        <!-- page header/blog hero, use custom cover image if available
        ================================================== -->
            <div class="page-header page-header--single page-hero" style="background-image:url(https://leemengtaiwan.github.io/theme/images/background/raj-eiamworakul-603747-unsplash.jpg)">

            <div class="row page-header__content narrow">
                <article class="col-full">
                    <div class="page-header__info">
                        <div class="page-header__cat">
                            <a href="https://leemengtaiwan.github.io/tag/python.html" rel="tag">Python</a>
                            <a href="https://leemengtaiwan.github.io/tag/airflow.html" rel="tag">Airflow</a>
                            <a href="https://leemengtaiwan.github.io/tag/zi-liao-gong-cheng.html" rel="tag">資料工程</a>
                            <a href="https://leemengtaiwan.github.io/tag/selenium.html" rel="tag">Selenium</a>
                            <a href="https://leemengtaiwan.github.io/tag/slack.html" rel="tag">Slack</a>
                        </div>
                    </div>
                    <h1 class="page-header__title">
                        <a href="https://leemengtaiwan.github.io/drafts/how-i-use-python-and-airflow-to-help-me-catch-up-with-latest-comic-with-ease.html" title="">
                            如何用 Python 追漫畫連載 - Airflow 從零到專精之路
                        </a>
                    </h1>
                    <ul class="page-header__meta">
                        <li class="date">2018-08-19 (Sun)</li>
                        <li class="page-view">
                            1 views
                        </li>
                    </ul>

                </article>
            </div>

        </div> <!-- end page-header -->

        <div class="KW_progressContainer">
            <div class="KW_progressBar"></div>
        </div>


        <div class="row blog-content" style="position: relative">
<div id="left-navigation">

    <div id="search-wrap">
        <i class="im im-magnifier" aria-hidden="true"></i>
        <div id="search">
            <form action="../search.html">
            <div class="tipue_search_right"><input type="text" name="q" id="tipue_search_input" pattern=".{2,}" title="想搜尋什麼呢？（請至少輸入兩個字）" required></div>
            </form>
        </div>
    </div>

    <div id="toc-wrap">
        <a title="顯示/隱藏 文章章節">
            <i class="im im-menu" aria-hidden="true" onclick="toggleTovNav()"></i>
        </a>
    </div>


</div>
            <div class="col-full blog-content__main">
                
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><blockquote><p>這是一篇當初我在入門資料工程以及 Airflow 時希望有人能為我寫好的文章。</p></blockquote></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://airflow.apache.org/">Airflow</a> 是一個從 Airbnb 誕生並開源，以 <a href="https://www.python.org/">Python</a> 寫成的<a href="https://zh.wikipedia.org/wiki/%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F">工作流程管理系統（Workflow Management System）</a>，也是<a href="https://github.com/apache/incubator-airflow#who-uses-airflow">各大企業</a>的資料工程環節中不可或缺的利器之一。</p>
<p>近年不管是資料科學家、資料工程師還是任何需要處理數據的軟體工程師，Airflow 都是他們用來建構可靠的 ETL 以及定期處理批量資料的首選之一。（事實上在 <a href="https://www.smartnews.com/en/">SmartNews</a>，除了 DS/DE，會使用 Airflow 的軟體工程師也不在少數）</p>
<center>
<img src="https://leemengtaiwan.github.io/images/journal/smartnews-dmp.png" style="width:90%"/>
</center>
<center>
    我們在
    <a href="https://leemengtaiwan.github.io/journey-of-data-scientist-L-part-1-two-must-ask-questions-when-on-board.html#%E5%84%80%E8%A1%A8%E6%9D%BF%E4%B8%8A%E7%9A%84-KPI-%E6%98%AF%E6%80%8E%E9%BA%BC%E7%94%A2%E7%94%9F%E7%9A%84%EF%BC%9F" target="_blank">「資料科學家 L 的奇幻旅程(1)：新人不得不問的 2 個問題</a>
    」一文提到 SmartNews 如何利用 Airflow 建立資料管道並管理各種 ETL
    <br/>
<br/>
<br/>
</center><p>儘管它的方便以及強大，在完全熟悉 Airflow 之前，因為有些專業術語以及資料工程概念的存在，不少初學者（包含當時的我）在剛開始的時候容易四處撞壁。另外如果一開始就以 ETL 當作 Airflow 的入門的話，未免難度過高且缺少共鳴。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="追連載：一個-Airflow-的輕鬆使用案例">追連載：一個 Airflow 的輕鬆使用案例<a class="anchor-link" href="#追連載：一個-Airflow-的輕鬆使用案例">&para;</a></h2><p>這篇文章希望以一個簡易的漫畫連載通知 App 作為引子，讓完全沒有資料工程經驗的讀者也能夠在了解工作流程的概念以及 Airflow 的使用方式的同時，不失趣味性以及實用性。你也將學會如何建立一個能在 Airflow 上運行的工作流程。等掌握基礎以後，你將能輕鬆地用從本文學到的知識做更進階的應用。</p>
<p>如果你對資料工程有興趣，不太熟悉 Airflow 但有基本的 Python 程式基礎的話（或是純粹對用 Python 寫一個漫畫連載通知 App 有興趣），我相信這篇文章應該會很適合你。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center>
<a href="https://airflow.apache.org/" target="_blank">
<img src="https://leemengtaiwan.github.io/images/airflow/app.jpg" style="width:90%"/>
</a>
<p>Slack 截圖：追漫畫應該要是件輕鬆的事情。<br/>我們將利用 Airflow 及
        <a href="http://selenium-python.readthedocs.io/" target="_blank">Selenium </a>來實作一個像這樣會每天從 <a href="https://slack.com/" target="_blank">Slack</a> 推送最新漫畫連載的 App
    <br/>
<br/>
</p></center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>想重新複習 ETL 概念的讀者可以參考先前的文章：<a href="https://leemengtaiwan.github.io/why-you-need-to-learn-data-engineering-as-a-data-scientist.html#%E8%B3%87%E6%96%99%E7%AE%A1%E9%81%93">資料科學家為何需要了解資料工程</a>。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="章節傳送門">章節傳送門<a class="anchor-link" href="#章節傳送門">&para;</a></h2><ul>
<li><a href="#所以為何要這-App-？">了解需求：所以為何要這 App ？</a></li>
<li><a href="#工作流概念-&amp;-Airflow">工作流概念 &amp; Airflow</a></li>
<li><a href="#Python-&amp;-Airflow-實作">Python 實作 &amp; Airflow 操作</a><ul>
<li><a href="#建置-Airflow-環境">建置 Airflow 環境</a></li>
<li><a href="#Airflow-基本概念">Airflow 基本概念</a></li>
<li><a href="#App-版本一：大鍋炒">App 版本一：大鍋炒</a><ul>
<li><a href="#輕鬆排程">輕鬆排程</a></li>
<li><a href="#將實作邏輯跟-DAG-排程分離">Operator 概念</a></li>
<li><a href="#測試開發-Airflow-工作">測試開發 Airflow 工作</a></li>
</ul>
</li>
<li><a href="#App-版本二：模組化">App 版本二：模組化</a><ul>
<li><a href="#Airflow-排程器">Airflow 排程器</a></li>
<li><a href="#手動觸發-DAG">手動觸發 DAG</a></li>
<li><a href="#定義工作流程">定義工作流程</a></li>
<li><a href="#Airflow-變數以及-Jinja-模板">Airflow 變數以及 Jinja 模板</a></li>
<li><a href="#Backfill：回到過去">Backfill：回到過去</a></li>
</ul>
</li>
<li><a href="#App-版本三：填填樂">App 版本三：填填樂</a></li>
</ul>
</li>
<li><a href="#結語">結語</a></li>
</ul>
<p>為讓讀者完整了解開發這個 App 的背景脈絡、此 App 的執行邏輯以及使用 Airflow 來定期執行 App 的原因，在我們實際開始寫 Python 之前有兩小節的解說。</p>
<p>如果你已經有 Airflow 及工作流程的基礎知識，且迫不及待想看 Python 程式碼，可以直接跳到 <a href="#Python-&amp;-Airflow-實作">Python 實作 &amp; Airflow 操作</a>章節之後再回來查看前面段落。</p>
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/toc-demo.png" style="width:90%"/>
<p>
        你有時可能會需要回到前面章節回顧一些內容。活用左側放大鏡按鈕下面的章節傳送門能讓你更輕鬆地徜徉在本文的 Airflow 世界（此功能目前寬螢幕限定，抱歉）
    </p>
<br/>
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="所以為何要這-App-？">所以為何要這 App ？<a class="anchor-link" href="#所以為何要這-App-？">&para;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>平常有在網路上追漫畫連載的讀者們應該都了解，市面上的漫畫網站通常都不是會員制的。更不用說「在新連載出的時候自動通知您！」這種推送功能（Push Notification）了。也因為這樣，導致我常常三不五時上去這些漫畫網站，看每個關注的漫畫到底出了最新一話了沒。可想而知，答案通常是否定的。（一週出一次每天檢查也沒用啊啊啊）</p>
<p>如果你只看海賊王一個漫畫（索隆好帥！），這或許沒什麼負擔。但就像上面 Slack 截圖顯示的，我不只關注海賊王，還看很多其他漫畫。讓事情更糟的是，到最後你會發現：</p>
<ul>
<li>不記得自己到底在追哪些漫畫</li>
<li>每一部漫畫最後到底是看到第幾話</li>
<li>上一話是什麼時候出的</li>
<li>有幾話是新出而你還沒看的 </li>
</ul>
<center>
<a href="https://airflow.apache.org/" target="_blank">
<img src="https://leemengtaiwan.github.io/images/airflow/tim-gouw-68319-unsplash.jpg" style="width:90%"/>
</a>
<p>手動追最新連載經常讓我追到懷疑人生</p>
<br/>
</center><p>追漫畫連載應該要是個輕鬆且享受的事情。在一個人人會寫 code 的時代，何不自己做個 App 幫我們自動「檢查新連載」這件事情呢？</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="工作流概念-&amp;-Airflow">工作流概念 &amp; Airflow<a class="anchor-link" href="#工作流概念-&amp;-Airflow">&para;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>概念上我們可以把此 App 需要做的工作按照「先後順序」由上往下列出來：</p>
<ul>
<li>取得使用者的閱讀紀錄</li>
<li>去漫畫網站看有沒有新的章節</li>
<li>跟紀錄比較，有沒有新連載？<ul>
<li>沒有：<ul>
<li>什麼都不幹，結束</li>
</ul>
</li>
<li>有：<ul>
<li>寄 Slack 通知</li>
<li>更新閱讀紀錄</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>想像上述的工作清單由上往下流動，就形成了一個工作流程（Workflow）：前一個工作如寄 Slack 通知就是下一個工作：更新閱讀紀錄的上游工作（Upstream Task）。</p>
<p>反過來說，更新閱讀紀錄則是寄 Slack 通知的下游工作（Downstream Task）。</p>
<p>定義出工作之間的上下游關係的好處是什麼？</p>
<p>可以讓我們確保工作之間的相依性（Dependencies）並讓如 Airflow 這種工作流程管理系統幫我們管理。一般而言，下游工作只能在上游「成功」完成之後被執行；如果上游工作失敗的話，下游工作應該被終止，通常也沒有繼續執行的意義（例：如果 App 在執行上游工作「取得使用者閱讀紀錄」時就失敗的話，不需要也不應該執行下游的「更新閱讀紀錄」工作）。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center>
<a href="https://airflow.apache.org/" target="_blank">
<img src="https://leemengtaiwan.github.io/images/airflow/www-headsmartmedia-com-179929-unsplash.jpg" style="width:90%"/>
</a>
<p>我們的 App 實際上就是一個完整的工作流程。<br/>
       App 從工作 A 執行到工作 B 就像是水從上游 A 流動到下游 B 一樣。</p>
<br/>
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>我知道你在想什麼。</p>
<p>屏除剛剛介紹的工作流程概念，要實作這 App 的邏輯一點都不難。事實上我們只需要寫個 Python script，把每個工作各別用一個函式（Function）實作後再按照順序呼叫它們就好（你甚至可以只用一個函式實現所有邏輯！），為何需要 Airflow？</p>
<p>在你往下滑前給個提示：我們這個 App 不是每一秒鐘都在執行。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/thought-2123970_1280.jpg" style="width:90%"/>
<br/>
<br/>
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>對！顯而易見的，因為這個 App / 工作流程設計的方式不是即時工作（Realtime Job），而是批次工作，執行一次以後就結束它的生命了。</p>
<p>我們可不希望它只在明天早上（比方說早上 9 點）去檢查新連載。我們希望它明天、下個月或是明年的今天早上都在運作。這也是為何我們需要一個像是 Airflow 的工作流程管理系統：</p>
<ol>
<li>定期執行工作流程</li>
<li>維護相依性，確保工作流程從上游到下游執行，不會在上游沒完成前執行到下游</li>
<li>各個工作失敗時自動重試（<a href="https://zh.wikipedia.org/wiki/%E6%91%A9%E8%8F%B2%E5%AE%9A%E7%90%86">墨菲定律</a>，所有你認為邏輯上萬無一失的工作都會因為各種無法預期的情況給你失敗的驚喜）</li>
<li>簡單易懂的 <a href="https://airflow.apache.org/">Web UI</a> 方便管理工作流程</li>
</ol>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><blockquote><p>Airflow 非常適合用來管理相依性複雜，且具批次處理性質的工作流程。</p></blockquote></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center>
<a href="https://airflow.apache.org/" target="_blank">
<img src="https://leemengtaiwan.github.io/images/airflow/airflow.gif" style="width:90%"/>
</a>
<p>Airflow 的 <a href="https://airflow.apache.org/" target="_blank">Web UI</a> 讓我們能更輕鬆地管理及排程工作流程（後面我們會實際利用此 UI 管理並開發 App）</p>
<br/>
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>事實上我們也可以透過 Linux 排程工具 <a href="https://zh.wikipedia.org/wiki/Cron">Cron</a> 來定期執行我們的 App。但 Cron 本身沒有工作流程的概念，沒辦法管理上下游工作的相依性、失敗時無法自動重跑、當然也沒有易懂的 Web UI。因此以 2, 3, 4 項的角度來看，Airflow 是一個比較好的選擇。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>到此為止，我們已經了解</p>
<ul>
<li>為何要做這個 App</li>
<li>此 App 的工作流程以及工作流程（Workflow）的基本概念</li>
<li>為何要使用 Airflow 來幫我們管理 App 的工作流程</li>
</ul>
<p>接著只差用 Python 將 App 的邏輯以 Airflow 工作流程的方式實現了，讓我們開始實作吧！</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/show-me-the-code.jpg" style="width:90%"/>
<p>[Warning] 接下來不只給你 Python 程式碼，而是給你大量的 Python 程式碼</p>
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Python-&amp;-Airflow-實作">Python &amp; Airflow 實作<a class="anchor-link" href="#Python-&amp;-Airflow-實作">&para;</a></h2><p>程式碼都會放在這個 <a href="https://github.com/leemengtaiwan/airflow-tutorials">Github Repo</a> 裡頭供你在閱讀完文章後參考。但如果你正在用電腦瀏覽的話且想趕快熟悉 Airflow 開發的話，可以 <code>git clone</code> 下來以後跟著文章走。</p>
<p>開啟一個新的 terminal，移動到你平常放新專案的資料夾，然後輸入：</p>
<div class="highlight"><pre><span></span>git clone https://github.com/leemengtaiwan/airflow-tutorials.git
<span class="nb">cd</span> airflow-tutorials
</pre></div>
<p>之後沒特別明說的話，指令都會是在 <code>airflow-tutorials</code> 資料夾底下執行。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="建置-Airflow-環境">建置 Airflow 環境<a class="anchor-link" href="#建置-Airflow-環境">&para;</a></h3><p>雖然 production 環境需要很多調整，以建構測試環境來說，基本上參考官方的 <a href="https://airflow.apache.org/start.html#quick-start">Quick Start</a> 就可以很輕鬆地完成。因為 Airflow 是以 Python 實作的，我們可以很輕易地用 <code>pip install</code> 來安裝所有需要的東西。用 <a href="https://anaconda.org/">Anaconda</a> 則是能讓你事後管理不同專案的環境時輕鬆不少：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span>conda create -n airflow-tutorials <span class="nv">python</span><span class="o">=</span><span class="m">3</span>.6 -y
<span class="nb">source</span> activate airflow-tutorials
pip install <span class="s2">"apache-airflow[crypto, slack]"</span>
<span class="nb">export</span> <span class="nv">AIRFLOW_HOME</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">"</span>
airflow initdb
</pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>以上的指令幫我們：</p>
<ul>
<li>建立並啟動一個新的 Anaconda 環境</li>
<li>在此環境下安裝 Airflow 以及<a href="https://airflow.apache.org/installation.html#extra-packages">支援 Slack 功能的額外函式庫</a></li>
<li>設定專用路徑以讓 Airflow 之後知道要在哪找檔案、存 log</li>
<li>初始化 Airflow Metadata DB。此 DB 被用來記錄所有工作流程的執行狀況</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>理想上把 <code>AIRFLOW_HOME</code> 加入到 <code>~/.bash_profile</code> 裡頭之後會比較輕鬆，不過現在不做也沒關係。</p>
<p>在環境都搞定之後，我們可以啟動 Airflow 的網頁伺服器：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span>airflow webserver -p <span class="m">8080</span>
</pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>接著在瀏覽器輸入 <code>localhost:8080</code> 就能看到 Airflow 簡潔的 Web UI 了：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/first-impression-of-airflow-web-ui.jpg" style="width:90%"/>
<p>Airflow Web UI 首頁：顯示所有已定義的工作流程（DAG）。<br/>
        圖中的 3 個 DAG 就對應到我們接下來逐漸改善 App 時產生的三個 App 版本</p>
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Airflow-基本概念">Airflow 基本概念<a class="anchor-link" href="#Airflow-基本概念">&para;</a></h3><p>這邊值得注意的是 Airflow 利用 <a href="https://airflow.apache.org/concepts.html#dags">DAG</a> 一詞來代表一種特殊的工作流程（Workflow）。如工作流程一樣，DAG 定義了我們有什麼工作、工作之間的執行順序以及依賴關係。DAG 的最終目標是將所有工作依照上下游關係全部執行，而不是關注個別的工作實際上是怎麼被實作的（這點在後面的 <a href="#Operator：將實作邏輯跟-DAG-排程分離">Operator</a> 章節會有詳細解釋）。</p>
<p>另外從它的全名<a href="http://www.csie.ntnu.edu.tw/~u91029/DirectedAcyclicGraph.html">有向無環圖（<strong>D</strong>irected <strong>A</strong>cyclic <strong>G</strong>raph）</a>你可以看出它具備兩個特色：「有向」及「無環」。事實上我們的 App 邏輯就是一個理想的 DAG。首先，裡頭包含多個邏輯上的工作：</p>
<ul>
<li>取得使用者的閱讀紀錄</li>
<li>去漫畫網站看有沒有新的章節</li>
<li>跟紀錄比較，有沒有新連載？<ul>
<li>沒有：<ul>
<li>什麼都不幹，結束</li>
</ul>
</li>
<li>有：<ul>
<li>寄 Slack 通知</li>
<li>更新閱讀紀錄</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>很明顯地， App 是從上而下地執行每個工作，即為「有向」；同時 App 不會在更新閱讀紀錄以後（下游工作），還跑回去漫畫網站看有沒有新的章節（上游工作）：上游會指向下游，但下游不會指回上游，此即「無環」。</p>
<p>有了這個理解以後，我們的目標就很明顯了：將 App 的工作流程轉換成一個能在 Airflow 上執行的 DAG，然後排程它，就能讓它每天去找新連載！</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="App-版本一：大鍋炒">App 版本一：大鍋炒<a class="anchor-link" href="#App-版本一：大鍋炒">&para;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>在 Airflow 世界裡，一個 DAG 是由一個 Python script 所定義的。</p>
<p>以下是我們 App 的第一個版本，也是最簡單的 DAG <code>comic_app_v1</code> 的程式碼（<code>airflow-tutorials/dags</code> 資料夾底下的 <code>comic_app_v1.py</code>）：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span> <span class="nn">airflow.operators.python_operator</span> <span class="kn">import</span> <span class="n">PythonOperator</span>

<span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'owner'</span><span class="p">:</span> <span class="s1">'Meng Lee'</span><span class="p">,</span>
    <span class="s1">'start_date'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">'schedule_interval'</span><span class="p">:</span> <span class="s1">'@daily'</span><span class="p">,</span>
    <span class="s1">'retries'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">'retry_delay'</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">fn_superman</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"取得使用者的閱讀紀錄"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"去漫畫網站看有沒有新的章節"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"跟紀錄比較，有沒有新連載？"</span><span class="p">)</span>

    <span class="c1"># Murphy's Law</span>
    <span class="n">accident_occur</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">accident_occur</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">天有不測風雲,人有旦夕禍福"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"工作遇到預期外狀況被中斷</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">new_comic_available</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">new_comic_available</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"寄 Slack 通知"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"更新閱讀紀錄"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"什麼都不幹，工作順利結束"</span><span class="p">)</span>


<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">'comic_app_v1'</span><span class="p">,</span> <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
    <span class="n">superman_task</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'superman_task'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">fn_superman</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>為了讓你能專注在 Airflow 及 DAG 最核心的概念，讓我先用 <code>print()</code> 假裝我們已經在一個函式 <code>fn_superman</code> 裡頭實作所有工作的邏輯了。在修改完代表一個 DAG 的 Python script 後，要確保 Airflow 能正確地將其視為一個 DAG，最基本的檢查就是用 Python 直接執行該 script。</p>
<p>你目前的 terminal 應該正被 Airflow 的網頁伺服器所使用。如果你還沒有把 <code>AIRFLOW_HOME</code> 加到 <code>~/.bash_profile</code> 裡頭的話，開啟一個新的 terminal，重新進入 <code>airflow-tutorials</code> 資料夾以後執行：</p>
<div class="highlight"><pre><span></span><span class="nb">source</span> activate airflow-tutorials
<span class="nb">export</span> <span class="nv">AIRFLOW_HOME</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">"</span>
</pre></div>
<p>這邊我們為新的 terminal 啟動 Anaconda 環境，並告訴 Airflow 在 <code>airflow-tutorials</code> 資料夾底下找所有它要的東西。（之後要打開新的 terminal 也要做一樣的事情）</p>
<p>接著我們就可以用 Python 測試 script 的正確性：</p>
<div class="highlight"><pre><span></span>python dags/comic_app_v1.py
</pre></div>
<p>沒有特別設定的話， Airflow 會去 <code>AIRFLOW_HOME</code> 路徑底下的 <code>dags</code> 子資料夾找 DAG，這也是為何我們在上面路徑有個 <code>dags</code>。（你可以去 <a href="https://github.com/leemengtaiwan/airflow-tutorials">Repo</a> 確定檔案的路徑。）</p>
<p>如果沒有任何錯誤跑出來，恭喜！Airflow 能將其視為一個正常的 DAG 並顯示在 Web UI 上。之後只要你有修改 DAG 裡頭的程式碼，都應該做這個檢查。</p>
<p>這個 DAG 的程式碼雖不長，卻隱含了一些非常重要的概念。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="輕鬆排程">輕鬆排程<a class="anchor-link" href="#輕鬆排程">&para;</a></h4><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">'comic_app_v1'</span><span class="p">,</span> <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
<p>靠近 <a href="#App-版本一：大鍋炒">Script</a> 尾端的這行實際上就定義了我們的 DAG 並將它命名為 <code>comic_app_v1</code>。而此 DAG 的排程（Scheduling）設定如</p>
<ul>
<li><code>'start_date': datetime(2100, 1, 1, 0, 0)</code> 代表從西元 2100 年開始第一次執行此 DAG </li>
<li>每次執行之間間隔多久。<code>'schedule_interval': '@daily'</code> 代表每天執行一次</li>
<li><code>'retries': 2</code> 則允許 Airflow 在 DAG 失敗時重試 2 次 </li>
<li>DAG 失敗後等多久後開始重試（<code>'retry_delay': timedelta(minutes=1)</code>　代表等一分鐘）</li>
<li>更多更多 ...</li>
</ul>
<p>乍看之下沒什麼了不起的，就是些設定。</p>
<p>但如果你有自己從頭實作過資料管道的經驗或者使用過 <a href="https://zh.wikipedia.org/wiki/Cron">Cron</a> 排程 ETL，就能體會 Airflow 這樣的「Configuration as Code」有多麽的強大：你只做一些設定（Config），Airflow 就幫你自動建立可靠、失敗時會自動重試的工作流程。</p>
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/utah-mechanical-contractors-1103725_1280.jpg" style="width:90%"/>
<p>按幾個按鈕就能做出可靠的工作流程，將自動化、失敗重試、相依性管理全部交給 Airflow</p>
</center><p>這些排程設定為了方便管理，一般都另外定義在 <code>default_args</code> 變數並放在 script 的最上面。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Operator：將實作邏輯跟-DAG-排程分離">Operator：將實作邏輯跟 DAG 排程分離<a class="anchor-link" href="#Operator：將實作邏輯跟-DAG-排程分離">&para;</a></h4><p>最有趣的是我們使用 <code>with</code> 關鍵字來定義一個只屬於 <code>comic_app_v1</code> DAG 的領域。在這裡頭我們則定義了唯一一個工作 <code>superman_task</code> 處理所有事情（你應該能猜到為何它被這樣命名）：</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">'comic_app_v1'</span><span class="p">,</span> <span class="o">...</span>
    <span class="n">superman_task</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'superman_task'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">fn_superman</span>
    <span class="p">)</span>
</pre></div>
<p>這段程式碼用白話翻譯的話，就是說：</p>
<ul>
<li>在 DAG <code>comic_app_v1</code> 裡頭，利用 <code>PythonOperator</code> 建立一個名為 <code>superman_task</code> 的工作，而實際執行這個工作的時候，呼叫 <code>fn_superman</code> 函式。</li>
</ul>
<p>一個非常重要且需要你搞懂的概念是，現在說的工作（Task），是指那些實際透過程式碼宣告，在 DAG 裡頭被定義出來的工作，如 <code>superman_task</code>。</p>
<p>前面我們提到，App 概念上本身就包含了多個工作（步驟）：</p>
<ul>
<li>取得使用者的閱讀紀錄</li>
<li>去漫畫網站看有沒有新的章節</li>
<li>跟紀錄比較，有沒有新連載？<ul>
<li>沒有：<ul>
<li>什麼都不幹，結束</li>
</ul>
</li>
<li>有：<ul>
<li>寄 Slack 通知</li>
<li>更新閱讀紀錄</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>這些是「邏輯上」的工作，而在 <code>comic_app_v1</code> DAG 裡頭，為了方便說明，我們將它們全部包起來，定義成唯一一個 Airflow 工作： <code>superman_task</code>。（在 <a href="#app-v2">App 版本二：模組化</a>章節裡，我們則會分別為這些「邏輯工作」建立他們自己的 Airflow 工作）。</p>
<p>回到 Opeartor 的話題。在 Airflow 裡頭，DAG 只知道有哪些工作以及這些工作之間的執行順序。而實際上這些工作要怎麼被完成，其實作邏輯則是由各種 <a href="https://airflow.apache.org/code.html#operators">Operator</a> 負責。</p>
<p>你可以想像 <a href="https://airflow.apache.org/code.html#airflow.operators">Opeartors</a> 就是幫我們完成特定種類工作的小幫手，像是一些常見的例子：</p>
<ul>
<li><a href="https://airflow.apache.org/code.html#airflow.operators.PythonOperator">PythonOperator</a> 執行一個 Python 函式</li>
<li><a href="https://airflow.apache.org/code.html#airflow.operators.BashOperator">BashOperator</a> 執行 Bash 指令</li>
<li><a href="https://airflow.apache.org/code.html#airflow.operators.S3KeySensor">S3KeySensor</a> 監測 S3 上的檔案存不存在</li>
<li><a href="https://airflow.apache.org/code.html#airflow.operators.SlackAPIPostOperator">SlackAPIPostOperator</a> 送訊息給 Slack</li>
<li>...</li>
</ul>
<p>要建立一個 DAG 裡的工作（Task）就是依照你想要它完成的特定目標，來選擇合適的 Operator。比方說上面的 <code>superman_task</code> 就是透過 <code>PythonOperator</code> 來執行特定的 Python 函式 <code>fn_superman</code>，而該函式則把 App 裡頭所有的「邏輯工作」實作了。</p>
<p><code>PythonOperator</code> 可以說是 Airflow 裡最基本也最強大的 <a href="https://airflow.apache.org/code.html#airflow.operators">Opeartors</a> 之一。學會使用方法以後，你可以將任何你定義的 Python 函式變成一個 Airflow 工作。</p>
<p>基本的使用方法非常簡單，你只要指定一個可呼叫的 Python 函式給 <code>python_callable</code> 參數以及設定一個工作名稱（task_id）即可：</p>
<div class="highlight"><pre><span></span><span class="n">superman_task</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s1">'superman_task'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">fn_superman</span>
<span class="p">)</span>
</pre></div>
<p>在後面的 <a href="#Airflow-變數以及-Jinja-模板">Airflow 變數以及 Jinja 模板</a>章節，我們則會看到如何使用其他 Operator 如 <a href="https://airflow.apache.org/code.html#airflow.operators.SlackAPIPostOperator">SlackAPIPostOperator</a> 來新增一個可以幫我們送 Slack 訊息的工作。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="測試開發-Airflow-工作">測試開發 Airflow 工作<a class="anchor-link" href="#測試開發-Airflow-工作">&para;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>你現在應該已經理解 DAG 本身關注的是有哪些工作以及他們的相依性，而不是各個工作的實作邏輯。（雖然在 <code>comic_app_v1</code> DAG 裡頭只有一個工作所以不存在相依性問題）</p>
<p>我們用 <code>python dags/comic_app_v1.py</code> 確保 DAG 本身沒有語法問題以後，接著就是要確保裡頭每個工作（Task）的執行結果如我們預期。</p>
<p>在 <code>comic_app_v1</code> DAG 裡頭，我們只有一個工作 <code>superman_task</code> （其透過一個函式 <code>fn_superman</code> 幫我們做所有邏輯上的工作）：</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fn_superman</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"取得使用者的閱讀紀錄"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"去漫畫網站看有沒有新的章節"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"跟紀錄比較，有沒有新連載？"</span><span class="p">)</span>

    <span class="c1"># Murphy's Law</span>
    <span class="n">accident_occur</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">accident_occur</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">天有不測風雲,人有旦夕禍福"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"工作遇到預期外狀況被中斷</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">new_comic_available</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">new_comic_available</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"寄 Slack 通知"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"更新閱讀紀錄"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"什麼都不幹，工作順利結束"</span><span class="p">)</span>


<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">'comic_app_v1'</span><span class="p">,</span> <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
    <span class="n">superman_task</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'superman_task'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">fn_superman</span>
    <span class="p">)</span>
</pre></div>
<p>這樣的設計有什麼優點？</p>
<p>一般來說 DAG 跟工作是一對多的關係（一個工作流程裡有多個小工作要做）：要讓一個 DAG 順利跑完，理所當然所有工作都要順利執行完畢。但 <code>comic_app_v1</code> DAG 是個特例，它裡頭只有一個工作，一人吃全家飽。只要測試且確保 <code>superman_task</code> 工作的執行結果如我們預期，就代表 DAG <code>comic_app_v1</code> 能順利完成，簡單易懂！</p>
<p>我們可以使用 Airflow 的 <code>test</code> 指令來幫我們測試這個工作：</p>
<div class="highlight"><pre><span></span>airflow <span class="nb">test</span> comic_app_v1 superman_task <span class="m">2018</span>-08-18
</pre></div>
<p>這行指令是讓 Airflow 幫我們測試 <code>comic_app_v1</code> DAG 裡頭的 <code>superman_task</code> 工作，並假設這個工作是在 <code>2018-08-18</code> 這個日期被執行。在我們的 App 例子中，<code>superman_task</code> 工作的執行結果基本上不會受到執行日期的影響，可以隨便你改。</p>
<p>但想像一個每天 24 點 0 分準備被啟動，從資料庫撈出數據並計算「當天」使用者數目的工作。其 SQL 查詢可能長這樣：</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_new_users</span>
<span class="k">FROM</span> <span class="n">user_activities</span>
<span class="k">WHERE</span> <span class="n">dt</span> <span class="o">=</span> <span class="s1">'{execute_date}'</span>
</pre></div>
<p>因為此工作的結果會受到執行日期的影響，在測試的時候，你就得仔細選擇執行日期（execute_date）。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>拉回 <code>superman_task</code> 工作的測試。</p>
<p>從上面 <code>fn_superman</code> 函式的程式碼你可能已經注意到，我埋了個小彩蛋，每次執行都會有不同的執行結果。</p>
<p>幸運的話你會得到下面這種：</p>
<div class="highlight"><pre><span></span>airflow <span class="nb">test</span> comic_app_v1 superman_task <span class="m">2018</span>-08-01
取得使用者的閱讀紀錄
去漫畫網站看有沒有新的章節
跟紀錄比較，有沒有新連載？
什麼都不幹，工作順利結束
</pre></div>
<p>喔耶！這執行結果如我們預期，可以讓 DAG 上線定期執行了！</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>不過別高興得太早。多執行幾次看看。如果墨菲定律發生，你會得到失敗的結果：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span>airflow <span class="nb">test</span> comic_app_v1 superman_task <span class="m">2018</span>-08-01
取得使用者的閱讀紀錄
去漫畫網站看有沒有新的章節
跟紀錄比較，有沒有新連載？

天有不測風雲,人有旦夕禍福
工作遇到預期外狀況被中斷
</pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>假設此執行結果不是我們預期的結果，該怎麼辦？</p>
<p>如果你反應夠快，會說：</p>
<p>「那又怎麼樣？墨菲定律不會每次發生，而且就算遇到而導致工作失敗的話， Airflow 不是會自己幫我們重試嗎？」</p>
<p>的確，這是我們在前面<a href="#輕鬆排程">輕鬆排程</a>章節提到 Airflow 的強處。畢竟我們這 App 只是在檢查最新連載，不是做什麼很複雜的運算。基本上就算 DAG 裡頭這唯一一個工作 <code>superman_task</code> 失敗了導致整個 DAG 要重跑，Airflow 也可以應付得來。</p>
<p>但問題在於，企業在運行資料管道的時候，常常需要分成很多步驟，某些步驟可能需要龐大的計算資源跟時間（像是將每天使用者使用 App 的幾億筆紀錄做匯總存入資料庫），有些則很輕量（如存取一個外部 API 取得外匯比例）。</p>
<p>現在假設你無視這些不同步驟的性質差異，將它們全部放在一個 <code>fn_superman</code> 函式裡頭並只建立一個 Airflow 工作，當該 Airflow 工作裡頭任何一個輕量的步驟失敗，Airflow 得重跑整個工作，導致所有龐大計算的步驟也得跟著重新執行，重試的時間/計算成本會大到你哭出來。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><blockquote><p>雞蛋不要放在同個籃子裡。為邏輯上獨立的工作/步驟分別建立 Airflow 工作，可以讓 Airflow 只從失敗的工作開始重新做起。</p></blockquote></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>因此一個比較好的 Airflow DAG 設計模式是為我們 App 裡頭每個邏輯上獨立的工作：</p>
<ul>
<li>取得使用者的閱讀紀錄</li>
<li>去漫畫網站看有沒有新的章節</li>
<li>跟紀錄比較，有沒有新連載？<ul>
<li>沒有：<ul>
<li>什麼都不幹，結束</li>
</ul>
</li>
<li>有：<ul>
<li>寄 Slack 通知</li>
<li>更新閱讀紀錄</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>都分別建立如同 <code>superman_task</code> 的 Airflow 工作，並定義好它們之間的相依性（Dependencies）。而這將是我們下一節的重點。</p>
<p>題外話：你可能會納悶為何我們只測試 <code>superman_task</code> 工作而沒測試整個 <code>comic_app_v1</code> DAG。當然「一人吃全家飽」是個理由：只要確定 DAG 裡頭唯一一個工作正確運作，我們就能保證此 DAG 沒問題。</p>
<p>事實上還有一個原因：<code>airflow test</code> 指令實際上只能用來測試單一工作，而不能測試整個 DAG。關於 DAG 的測試我們在後面的 <a href="#Airflow-排程器">Airflow 排程器</a> 章節會詳細說明。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="App-版本二：模組化_1"><a name="app-v2"></a>App 版本二：模組化<a class="anchor-link" href="#App-版本二：模組化">&para;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>所以現在我們要做的改善（Refactoring）很簡單：</p>
<ul>
<li>將 App 邏輯從 <code>comic_app_v1</code> DAG 中的函式 <code>fn_superman</code> 中拿出來</li>
<li>為 App 的每個步驟分別定義一個 Python 函式</li>
<li>在 DAG 裡頭利用 <code>PythonOperator</code> 建立多個 Airflow 工作並分別呼叫這些函式</li>
<li>定義這些工作的執行順序</li>
</ul>
<p>版本二的 App 完整的程式碼如下：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span> <span class="nn">airflow.operators.python_operator</span> <span class="kn">import</span> <span class="n">PythonOperator</span><span class="p">,</span> <span class="n">BranchPythonOperator</span>
<span class="kn">from</span> <span class="nn">airflow.operators.dummy_operator</span> <span class="kn">import</span> <span class="n">DummyOperator</span>
<span class="kn">from</span> <span class="nn">airflow.operators.slack_operator</span> <span class="kn">import</span> <span class="n">SlackAPIPostOperator</span>

<span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'owner'</span><span class="p">:</span> <span class="s1">'Meng Lee'</span><span class="p">,</span>
    <span class="s1">'start_date'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">'schedule_interval'</span><span class="p">:</span> <span class="s1">'@daily'</span><span class="p">,</span>
    <span class="s1">'retries'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">'retry_delay'</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">process_metadata</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">'read'</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"取得使用者的閱讀紀錄"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">'write'</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"更新閱讀紀錄"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_comic_info</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">):</span>
    <span class="n">all_comic_info</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">'task_instance'</span><span class="p">]</span><span class="o">.</span><span class="n">xcom_pull</span><span class="p">(</span><span class="n">task_ids</span><span class="o">=</span><span class="s1">'get_read_history'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"去漫畫網站看有沒有新的章節"</span><span class="p">)</span>

    <span class="n">anything_new</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">anything_new</span><span class="p">,</span> <span class="n">all_comic_info</span>


<span class="k">def</span> <span class="nf">decide_what_to_do</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">):</span>
    <span class="n">anything_new</span><span class="p">,</span> <span class="n">all_comic_info</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">'task_instance'</span><span class="p">]</span><span class="o">.</span><span class="n">xcom_pull</span><span class="p">(</span><span class="n">task_ids</span><span class="o">=</span><span class="s1">'check_comic_info'</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">"跟紀錄比較，有沒有新連載？"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">anything_new</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'yes_generate_notification'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'no_do_nothing'</span>


<span class="k">def</span> <span class="nf">generate_message</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">all_comic_info</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">'task_instance'</span><span class="p">]</span><span class="o">.</span><span class="n">xcom_pull</span><span class="p">(</span><span class="n">task_ids</span><span class="o">=</span><span class="s1">'check_comic_info'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"產生要寄給 Slack 的訊息內容並存成檔案"</span><span class="p">)</span>


<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">'comic_app_v2'</span><span class="p">,</span> <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="n">get_read_history</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'get_read_history'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">process_metadata</span><span class="p">,</span>
        <span class="n">op_args</span><span class="o">=</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">check_comic_info</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'check_comic_info'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">check_comic_info</span><span class="p">,</span>
        <span class="n">provide_context</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>

    <span class="n">decide_what_to_do</span> <span class="o">=</span> <span class="n">BranchPythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'new_comic_available'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">decide_what_to_do</span><span class="p">,</span>
        <span class="n">provide_context</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>

    <span class="n">update_read_history</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'update_read_history'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">process_metadata</span><span class="p">,</span>
        <span class="n">op_args</span><span class="o">=</span><span class="p">[</span><span class="s1">'write'</span><span class="p">],</span>
        <span class="n">provide_context</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>

    <span class="n">generate_notification</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'yes_generate_notification'</span><span class="p">,</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">generate_message</span><span class="p">,</span>
        <span class="n">provide_context</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>

    <span class="n">send_notification</span> <span class="o">=</span> <span class="n">SlackAPIPostOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'send_notification'</span><span class="p">,</span>
        <span class="n">token</span><span class="o">=</span><span class="s2">"YOUR_SLACK_TOKEN"</span><span class="p">,</span>
        <span class="n">channel</span><span class="o">=</span><span class="s1">'#comic-notification'</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">"[{{ ds }}] 海賊王有新番了!"</span><span class="p">,</span>
        <span class="n">icon_url</span><span class="o">=</span><span class="s1">'http://airbnb.io/img/projects/airflow3.png'</span>
    <span class="p">)</span>

    <span class="n">do_nothing</span> <span class="o">=</span> <span class="n">DummyOperator</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s1">'no_do_nothing'</span><span class="p">)</span>

    <span class="c1"># define workflow</span>
    <span class="n">get_read_history</span> <span class="o">&gt;&gt;</span> <span class="n">check_comic_info</span> <span class="o">&gt;&gt;</span> <span class="n">decide_what_to_do</span>

    <span class="n">decide_what_to_do</span> <span class="o">&gt;&gt;</span> <span class="n">generate_notification</span>
    <span class="n">decide_what_to_do</span> <span class="o">&gt;&gt;</span> <span class="n">do_nothing</span>

    <span class="n">generate_notification</span> <span class="o">&gt;&gt;</span> <span class="n">send_notification</span> <span class="o">&gt;&gt;</span> <span class="n">update_read_history</span>
</pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>天啊這可比 <code>comic_app_v1</code> DAG 的程式碼長了不少！</p>
<p>不過在你開始懷疑自己適不適合寫 Airflow DAG 之前讓我提醒你一下。就跟我們剛剛上面提到的，實際上這個 <code>comic_app_v2</code> DAG 的架構從上到下也就分為三個區塊：</p>
<ol>
<li>用 <code>def</code> 定義負責實作的 Python 函式（們）</li>
<li>在 DAG 利用各種 <code>Operator</code> 定義 DAG 工作（大部分是 <code>PythonOperator</code>，並使用 <code>python_callable</code> 指定執行步驟 1 定義的函式）</li>
<li>定義這些 DAG 工作的執行順序（Workflow）</li>
</ol>
<p>回頭再看一遍，有沒有清楚一點了？</p>
<p>在細看 <code>comic_app_v2</code> 的程式碼前，先讓我們用 Airflow Web UI 研究一下這個 DAG 在做什麼：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center>
<a ,="" href="https://leemengtaiwan.github.io/images/airflow/comic_app_v2_graph_view.gif" target="_blank">
<img src="https://leemengtaiwan.github.io/images/airflow/comic_app_v2_graph_view.png" style="width:90%"/>
</a>
<p>Airflow Web UI 裡頭的 Graph View 幫我們視覺化 DAG 的工作流程<br/>
        （<a ,="" href="https://leemengtaiwan.github.io/images/airflow/comic_app_v2_graph_view.gif" target="_blank">這個 GIF 展示如何從 Airflow UI 開啟此畫面</a>）
    </p>
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Airflow 工作寫成英文是為了方便使用 <code>airflow test</code> 指令測試每個工作。</p>
<p>儘管工作名稱都是英文，你應該不會覺得陌生。因為這就是我們 App 的邏輯：</p>
<ul>
<li>取得使用者的閱讀紀錄（get_read_history）</li>
<li>去漫畫網站看有沒有新的章節（check_comic_info）</li>
<li>跟紀錄比較，有沒有新連載？（new_comic_available）<ul>
<li>沒有（no_do_nothing）</li>
<li>有（yes_generate_notification）<ul>
<li>寄 Slack 通知（send_notification）</li>
<li>更新閱讀紀錄（update_read_history）</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>看來這應該不是巧合：）</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Airflow-排程器">Airflow 排程器<a class="anchor-link" href="#Airflow-排程器">&para;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>如同當初測試 <code>comic_app_v1</code> DAG 裡頭的 <code>superman_task</code> 工作一樣，在我們放心讓 Airflow 幫我們排程 <code>comic_app_v2</code> DAG 以前，應該分別測試裡頭所有工作，確保它們的執行結果如我們預期：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span>airflow <span class="nb">test</span> comic_app_v2 get_read_history <span class="m">2018</span>-01-01
取得使用者的閱讀紀錄

airflow <span class="nb">test</span> comic_app_v2 check_comic_info <span class="m">2018</span>-01-01
跟紀錄比較，有沒有新連載？

airflow <span class="nb">test</span> comic_app_v2 new_comic_available <span class="m">2018</span>-01-01
去漫畫網站看有沒有新的章節

...
</pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>假設我們已經做完所有工作的測試，想讓 <code>comic_app_v2</code> DAG 開始被 Airflow 排程，除了已經被開啟的 Airflow 網頁伺服器以外，我們需要另外開啟 Airflow 排程器（Scheduler）。</p>
<p>因為目前為止一直在運轉的 Airflow 網頁伺服器只負責：</p>
<ul>
<li>顯示 DAG 資訊，如工作流程圖、各個 DAG 的運行狀況以及 Logs</li>
<li>讓我們輕鬆地終止/開始 DAG 排程（在有排程器的前提）</li>
</ul>
<p>而實際要執行 DAG、分配每個工作的運算資源則需要 Airflow 排程器。Airflow 的架構圖能幫助我們理解這件事情：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/airflow-architecture.png" style="width:70%"/>
<p>
<a href="https://medium.com/@dustinstansbury/understanding-apache-airflows-key-concepts-a96efed52b1a" target="_blank">Airflow 架構圖</a>：Scheduler 是實際做排程、呼叫 Worker 執行工作的傢伙；我們熟悉的 Webserver 則提供一個 Web UI 讓我們可以輕鬆檢視工作執行時產生的 Logs、DAG 的程式碼以及工作的執行結果；所有資料都被存在 Metadata Database 裡頭。
    </p>
<br/>
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>事不宜遲，讓我們啟動 Airflow 排程器吧！</p>
<p>現在再打開一個 terminal，進入 <code>airflow-tutorials</code> 資料夾後設定環境：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">AIRFLOW_HOME</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">"</span>
<span class="nb">source</span> activate airflow-tutorials
</pre></div>
<p>接著啟動排程器：</p>
<div class="highlight"><pre><span></span>airflow scheduler
</pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>到目前為止你應該有 3 個 terminal 各司其職：</p>
<ul>
<li>用來輸入 <code>airflow</code> 相關指令的 terminal</li>
<li>Airflow Webserver</li>
<li>Airflow Scheduler</li>
</ul>
<p>我保証不會再多了。</p>
<p>有了排程器以後，打開 UI，在左邊將 <code>comic_app_v2</code> DAG 設成「On」後，點擊右邊「Trigger Dag」按鈕可以呼叫排程器馬上開始執行該 DAG。先讓我們按下去以後，再讓我解釋這樣做會發生什麼事情。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center>
<a ,="" href="https://leemengtaiwan.github.io/images/airflow/trigger-dag-demo.gif" target="_blank">
<img src="https://leemengtaiwan.github.io/images/airflow/ready-to-trigger-dag.png" style="width:90%"/>
</a>
<p>在左邊將 DAG 設成「On」後，可以利用右邊「Trigger Dag」按鈕呼叫排程器馬上開始執行該 DAG <br/>
        （<a ,="" href="https://leemengtaiwan.github.io/images/airflow/trigger-dag-demo.gif" target="_blank">這個 GIF 展示如何從 Airflow UI 觸發一個 DAG</a>）
</p></center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>為了避免預料之外的排程，Airflow 所有 DAG 的預設狀態都是暫停的（Paused），也就是上圖中如 <code>comic_app_v1</code> 左邊的「Off」。只有在你將 DAG 的狀態設定成如圖中的 <code>comic_app_v2</code> 的「On」，排程器才會開始為其做排程。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="手動觸發-DAG">手動觸發 DAG<a class="anchor-link" href="#手動觸發-DAG">&para;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>雖說將一個 DAG 取消暫停（Unpause）可以讓它成為 Airflow 的排程對象，實際上 Airflow 的排程又分兩種方式：</p>
<ul>
<li>手動觸發（Manual）<ul>
<li>常用在測試 DAG 或是有意外發生，需要手動重新執行 DAG 的時候</li>
</ul>
</li>
<li>定期執行（Scheduled）<ul>
<li>也就是所謂的「正式上線」。</li>
<li>依照 DAG 的 <code>start_date</code> 及 <code>schedule_interval</code> 設定決定何時執行</li>
</ul>
</li>
</ul>
<p>現在讓我們先專注在手動觸發。</p>
<p>當然你也可以在不透過 Web UI 的情況下，直接利用 terminal 取消暫停一個 DAG 並觸發它：</p>
<pre><code>airflow unpause comic_app_v2
airflow trigger_dag comic_app_v2</code></pre>
<p>理論上我們剛剛手動觸發的 <code>comic_app_v2</code> 應該已經跑完了。重新整理你應該會看到 Airflow UI 顯示 DAG 已被成功執行的畫面：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/success-dag.png" style="width:90%"/>
<br/>
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>從 Web UI 我們可以清楚地看到剛剛手動觸發的 <code>comic_app_v2</code> DAG 已經被 Airflow 排程器拿去執行，產生一個新的 DAG Run 並成功執行。DAG 跟 DAG Run 的差異在於前者只是個定義好的工作流程，後者則是該 DAG 在某個時間點實際被排程器拿去執行（Run）過後的結果，會有一個執行日期（execute_date）。</p>
<p>接著點擊右邊 Links 中長得像太陽的 Graph View 按鈕後就可以看到這個 DAG Run 的執行狀況：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/success-tasks-in-dag.png" style="width:90%"/>
<p>
        將游標放在右邊的「Success」狀態按鈕上可以顯示此 DAG Run 中被成功執行的工作（圖內的工作從左到右被執行）<br/>
        注意圖中 DAG Run 的 ID： manual_2018-08-19... 表示這是一個在 2018-08-19 被手動觸發的 DAG Run。
    </p>
<br/>
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>我們可以清楚地看到這個 DAG Run 完美地模擬了我們 App 在檢查到新連載情報時送 Slack 訊息給我們的情境。我甚至收到一個 Slack 訊息：</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/first-slack-message.png" style="width:90%"/>
<p>
        comic_app_v2 DAG 如果發現有新連載就會寄一個罐頭 Slack 訊息，包含 DAG 執行日期。因為我是在 2018-08-19 當天手動觸發此 DAG，因此日期即為 2018-08-19。後面我們會看到如何客製化 Slack 訊息內容。
    </p>
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="定義工作流程">定義工作流程<a class="anchor-link" href="#定義工作流程">&para;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>要在 DAG 裡頭定義出如上圖的工作流程也非常的直觀，讓我們參考這兩個工作：</p>
<ul>
<li>yes_generate_notification</li>
<li>send_notification</li>
</ul>
<p>它們在 <code>dags/comic_app_v2.py</code> 裡頭被這樣定義（節錄最重要的部分）：</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">'comic_app_v2'</span><span class="p">,</span> <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="o">...</span>

    <span class="n">generate_notification</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'yes_generate_notification'</span><span class="p">,</span>
        <span class="o">...</span>
    <span class="p">)</span>

    <span class="n">send_notification</span> <span class="o">=</span> <span class="n">SlackAPIPostOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'send_notification'</span><span class="p">,</span>
        <span class="o">...</span>
    <span class="p">)</span>

    <span class="c1"># define workflow</span>
    <span class="n">generate_notification</span> <span class="o">&gt;&gt;</span> <span class="n">send_notification</span> <span class="o">&gt;&gt;</span> <span class="o">...</span>
</pre></div>
<p>你可以發現在 <code>comic_app_v2</code> DAG 裡，我們分別定義好這兩個工作以後，在最下面用 <code>&gt;&gt;</code> 語法告訴 Airflow 這兩個工作的相依性：</p>
<ul>
<li><code>yes_generate_notification</code> 工作要在 <code>send_notification</code> 之前執行</li>
</ul>
<p>另外眼尖的讀者會發現，Python 變數名稱 <code>generate_notification</code> 跟實際上的工作名稱（task_id） <code>yes_generate_notification</code> 並不一致。我們將實際的工作 <code>PythonOperator</code> 命名為 <code>generate_notification</code>，只是為了後面在定義工作流程的時候好提到它。參考下面的程式碼：</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">'comic_app_v2'</span><span class="p">,</span> <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="o">...</span>

    <span class="n">task1</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'yes_generate_notification'</span><span class="p">,</span>
        <span class="o">...</span>
    <span class="p">)</span>

    <span class="n">task2</span> <span class="o">=</span> <span class="n">SlackAPIPostOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">'send_notification'</span><span class="p">,</span>
        <span class="o">...</span>
    <span class="p">)</span>

    <span class="c1"># define workflow</span>
    <span class="n">task1</span> <span class="o">&gt;&gt;</span> <span class="n">task2</span> <span class="o">&gt;&gt;</span> <span class="o">...</span>
</pre></div>
<p>這段程式碼跟上一段程式碼在定義工作流程上有一模一樣的效果，只是後者的 naming convention 在定義工作流程的時候比較易懂。</p>
<p>雖然要多打幾個字，為了其他 DS/DE 以及未來的自己，一般推薦 Python 變數名稱取跟 <code>task_id</code> 類似的名字。</p>
<p>針對其他工作，我們也是用相同語法將它們串起來：</p>
<div class="highlight"><pre><span></span><span class="o">...</span>

<span class="n">decide_what_to_do</span> <span class="o">=</span> <span class="n">BranchPythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s1">'new_comic_available'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">decide_what_to_do</span><span class="p">,</span>
    <span class="n">provide_context</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>

<span class="o">...</span>

<span class="n">get_read_history</span> <span class="o">&gt;&gt;</span> <span class="n">check_comic_info</span> <span class="o">&gt;&gt;</span> <span class="n">decide_what_to_do</span>

<span class="n">decide_what_to_do</span> <span class="o">&gt;&gt;</span> <span class="n">generate_notification</span>
<span class="n">decide_what_to_do</span> <span class="o">&gt;&gt;</span> <span class="n">do_nothing</span>

<span class="n">generate_notification</span> <span class="o">&gt;&gt;</span> <span class="n">send_notification</span> <span class="o">&gt;&gt;</span> <span class="n">update_read_history</span>
</pre></div>
<p>然後我們就得到前面看過的工作流程圖了：</p>
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/comic_app_v2_graph_view.png" style="width:90%"/>
</center><p>你也可以回到 <a href="#app-v2">App 版本二：模組化</a>章節，確認 <code>comic_app_v2</code> 完整的程式碼後再利用左邊的傳送門回來，我等你。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Airflow-變數以及-Jinja-模板">Airflow 變數以及 Jinja 模板<a class="anchor-link" href="#Airflow-變數以及-Jinja-模板">&para;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>現在你應該已經了解如何使用 <code>PythonOperator</code> 建立一個新的工作，並利用 <code>&gt;&gt;</code> 語法定義 Airflow 的工作流程（DAG）了。我們也實際觸發 <code>comic_app_v2</code> DAG 讓 Airflow 排程器幫我們排程，最後收到一個 Slack 訊息。</p>
<p>現在讓我們仔細研究一下負責寄 Slack 訊息的工作，也就是下圖的 <code>send_notificiation</code>：</p>
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/comic_app_v2_graph_view.png" style="width:90%"/>
<p>
        依照 Opeartor 種類不同，工作在 Web UI 上顯示的背景顏色也有所不同，方便區分。
    </p>
<br/>
</center><p>你會發現它的顏色跟其他工作不一樣，這是因為它並不是一個 <code>PythonOperator</code>，而是一個 <code>SlackAPIPostOperator</code>。由此 Operator 定義的工作並不會呼叫一個 Python 函式，而是直接呼叫 Slack API 來傳送訊息。下面是我們在當初落落長的 <code>comic_app_v2</code> DAG 裡頭定義的 <code>send_notificiation</code>：</p>
<div class="highlight"><pre><span></span><span class="n">send_notification</span> <span class="o">=</span> <span class="n">SlackAPIPostOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s1">'send_notification'</span><span class="p">,</span>
    <span class="n">token</span><span class="o">=</span><span class="s2">"YOUR_SLACK_TOKEN"</span><span class="p">,</span>
    <span class="n">channel</span><span class="o">=</span><span class="s1">'#comic-notification'</span><span class="p">,</span>
    <span class="n">text</span><span class="o">=</span><span class="s2">"[{{ ds }}] 海賊王有新番了!"</span><span class="p">,</span>
    <span class="n">icon_url</span><span class="o">=</span><span class="s1">'http://airbnb.io/img/projects/airflow3.png'</span>
<span class="p">)</span>
</pre></div>
<p>注意 <code>text</code> 參數的值。 <code>{{ ds }]</code> 實際上是 <a href="https://airflow.apache.org/tutorial.html#templating-with-jinja">Jinja</a> 語法，它允許我們將 Python 變數渲染（Render）到字串裡頭，動態地產生文本。這就像是我們有個變數 <code>ds</code>，然後利用 <code>format</code> 語法一樣：</p>
<pre><code>text = "[{ds}] 海賊王有新番了!".format(ds=ds)</code></pre>
<p>而這邊的重點是 Airflow 在執行一個 DAG 的時候會提供一些預設的<a href="https://airflow.apache.org/code.html?highlight=macros#macros">環境變數</a>供我們使用，像是：</p>
<ul>
<li><code>ds</code>：代表 DAG Run 的執行日期（execute_date），以 <code>YYYY-MM-DD</code> 形式表現</li>
<li><code>yesterday_ds</code>：DAG Run 的執行日期的前一天，以 <code>YYYY-MM-DD</code> 形式表現</li>
<li><code>tomorrow_ds</code>：DAG Run 的執行日期的後一天，以 <code>YYYY-MM-DD</code> 形式表現</li>
<li>...</li>
</ul>
<p>而因為我們在 2018-08-19 的時候，利用下面這個指令手動觸發 <code>comic_app_v2</code> DAG：</p>
<div class="highlight"><pre><span></span><span class="n">airflow</span> <span class="n">trigger_dag</span> <span class="n">comic_app_v2</span>
</pre></div>
<p>Airflow 會將實際執行該 DAG 的日期設定為執行日期（execute_date）。因此 <code>ds</code> 即為 <code>2018-08-19</code>，<code>SlackAPIPostOperator</code> 裡頭的 <code>"[{{ ds }}] 海賊王有新番了!"</code> 就會被渲染成 <code>[2018-08-19] 海賊王有新番了!</code>。</p>
<p>最後我們就得到這個 Slack 訊息：</p>
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/first-slack-message.png" style="width:90%"/>
<br/>
</center><p>現在你也了解使用 Jinja 語法可以動態地調整每次 DAG 運行的邏輯以及執行結果。讓我們實際將 <code>comic_app_v2</code> DAG 丟上線試試看吧！</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="執行時間：排程最重要的概念">執行時間：排程最重要的概念<a class="anchor-link" href="#執行時間：排程最重要的概念">&para;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>經過前面的幾個章節，我們已經對 <code>comic_app_v2</code> DAG 的測試及開發下了不少功夫：</p>
<ul>
<li>利用 <code>airflow test</code> 指令分別測試每個 Airflow 工作執行如預期</li>
<li><code>python dags/comic_app_v2.py</code> 確保 DAG 定義無誤</li>
<li>使用 Web UI 點擊「 Trigger Dag 」按鈕或是透過 <code>airflow trigger</code> 來手動觸發 DAG 確認結果</li>
</ul>
<p>這些都是將一個 DAG 正式上線前必須完成的步驟。在這些測試都完成以後，是時候將我們的 <code>comic_app_v2</code> DAG 交給 Airflow 排程器，讓 Airflow 幫我們每天執行這個 DAG 了！</p>
<p>在<a href="#手動觸發-DAG">手動觸發 DAG</a> 章節我們有看到，要讓 Airflow 排程器開始排程一個 DAG，首先要終止暫停（Unpause）該 DAG。而為何當時 Airflow 沒有在我們 <code>comic_app_v2</code>一終止暫停 就開始自動排程，而要等到我們手動觸發呢？</p>
<p>這是因為當時的 <code>comic_app_v2</code> 的排程設定如下：</p>
<div class="highlight"><pre><span></span><span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'owner'</span><span class="p">:</span> <span class="s1">'Meng Lee'</span><span class="p">,</span>
    <span class="s1">'start_date'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">'schedule_interval'</span><span class="p">:</span> <span class="s1">'@daily'</span><span class="p">,</span>
    <span class="o">...</span>

<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">'comic_app_v2'</span><span class="p">,</span> <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
<p><code>'start_date': datetime(2100, 1, 1, 0, 0)</code> 代表我們希望 <code>comic_app_v2</code> DAG 的第一個執行日期（execute_date）為西元 2100 年 1 月 1 號 0 點。</p>
<p>你可能覺得為何要把話說得那麼複雜，就說：</p>
<ul>
<li>「 Airflow 排程器會在 西元 2100 年 1 月 1 號 0 點第一次執行此 DAG 」</li>
</ul>
<p>不就好了嗎？</p>
<p>不這麼說的原因，就是因為上面的理解是錯的。事實上這是很多人在利用 Airflow 排程時最容易搞錯的<a href="https://airflow.readthedocs.io/en/latest/scheduler.html?highlight=start_date">概念</a>之一，值得花點篇幅徹底搞清楚。</p>
<p>假如西元 2100 年我們架的 Airflow 排程器還在運作的話，它會在：</p>
<div class="highlight"><pre><span></span>start_date 2100 年 1 月 1 號 0 點 0 分 + 1 * schedule_interval
=   2100 年 1 月 1 號 0 點 0 分 + 1 * @daily
=   2100 年 1 月 1 號 0 點 0 分 + 1 * 24 小時
=   2100 年 1 月 2 號 0 點 0 分
</pre></div>
<p>也就是 2100 年 1 月 2 號 0 點 0 分的時候，將 <code>comic_app_v2</code> DAG 拿出來做第一次執行，而該 DAG Run 的執行日期為 2100 年 1 月 1 號 0 點 0 分。</p>
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/black-man-question.jpg" style="width:90%"/>
<p>
        我知道你現在可能滿臉黑人問號，但讓我們好好想一想這到底是怎麼一回事。
    </p>
<br/>
</center><p>要理解為何我們一開始的猜想：</p>
<ul>
<li>「 Airflow 排程器會在 西元 2100 年 1 月 1 號 0 點第一次執行此 DAG 」</li>
</ul>
<p>是非常矛盾的，讓我們做個我最愛的假想實驗。還記得在<a href="#測試開發-Airflow-工作">測試開發 Airflow 工作</a>章節提到的 SQL 查詢嗎？</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_new_users</span>
<span class="k">FROM</span> <span class="n">user_activities</span>
<span class="k">WHERE</span> <span class="n">dt</span> <span class="o">=</span> <span class="s1">'{execute_date}'</span>
</pre></div>
<p>現在假設我們給這個工作跟 <code>comic_app_v2</code> 一模一樣的排程設定：</p>
<ul>
<li><code>'start_date': datetime(2100, 1, 1, 0, 0)</code></li>
<li><code>'schedule_interval': '@daily'</code></li>
</ul>
<p>根據本章節一開始的敘述，這個 DAG 的第一個執行日期（execute_date）為 <code>2100-01-01</code>。而按照我們在 <a href="#Airflow-變數以及-Jinja-模板">Airflow 變數以及 Jinja 模板</a>章節所說的，此 SQL 查詢裡頭的 Jinja 語法會被渲染成：</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_new_users</span>
<span class="k">FROM</span> <span class="n">user_activities</span>
<span class="k">WHERE</span> <span class="n">dt</span> <span class="o">=</span> <span class="s1">'2100-01-01'</span>
</pre></div>
<p>接著假設我們一開始的猜想：</p>
<ul>
<li>「 Airflow 排程器會在 西元 2100 年 1 月 1 號 0 點第一次執行此 DAG 」</li>
</ul>
<p>是對的話，該 SQL 查詢會取回什麼資料？</p>
<p>答案是什麼都沒有。</p>
<p>因為如果這猜想是對的話，這個 SQL 查詢工作會馬上在西元 2100 年 1 月 <strong>1</strong> 號的 0 點，想辦法去把西元 2100 年 1 月 <strong>1</strong> 號整天的使用者資料全部撈出來。而因為此 SQL 查詢執行時， 1 月 1 號才剛開始，這個查詢不會取得任何資料。</p>
<p>很明顯哪裡出了差錯了。</p>
<p>而如果照我剛剛解釋的版本，就會顯得合理許多：</p>
<ul>
<li>在 2100 年 1 月 <strong>2</strong> 號 0 點的時候，以下的 SQL 查詢會被執行</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_new_users</span>
<span class="k">FROM</span> <span class="n">user_activities</span>
<span class="k">WHERE</span> <span class="n">dt</span> <span class="o">=</span> <span class="s1">'2100-01-01'</span>
</pre></div>
<p>這代表我們在 1 月 1 號 23 點 59 分結束以後，也就是 1 月 2 號 0 點的時候，將 1 月 1 號所有的使用者資料做彙總。</p>
<p>一般而言，Airflow 會在 <code>start_date</code> 加上一個 <code>schedule_interval</code> 之後開始<a href="https://airflow.readthedocs.io/en/latest/scheduler.html?highlight=start_date">第一次執行某個 DAG</a>，而該 DAG Run 的 <code>execute_date</code> 為 <code>start_date</code>。這樣的設計就是為了避免像是上面那個 SQL 查詢在當天才剛開始的時候就想要搜集該天所有資料的窘境。</p>
<p>Airflow 擅長的是管理那些允許「事件發生時間」跟「實際數據處理時間」有落差的批次工作。因此 Airflow 都會在 <code>start_date</code> 加上 <code>schedule_interval</code> 長度的時間過完<strong>以後</strong>，才開始處理發生在 <code>start_date</code> 到 <code>start_date + schedule_interval</code> 之間的資料。</p>
<p>再換句話說，</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><blockquote><p>一個 DAG Run 中的執行日期，只等於它「負責」的日期，不等於它實際被 Airflow 排程器執行的日期。一個被自動排程且執行日期為 dt 的 DAG Run，實際上是在 dt + schedule_period 後被 Airflow 執行。</p></blockquote></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>我們換了好幾種說法，希望你能百分之百地掌握這個 Airflow 排程的概念。</p>
<p>有了這章節的排程概念以後，我們可以正式開始排程 <code>comic_app_v2</code> DAG 了！</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="正式排程">正式排程<a class="anchor-link" href="#正式排程">&para;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>經過上一章節排程概念的洗禮，想必你還記得 <code>comic_app_v2</code> DAG 的開始排程的日期（start_date）是遙遠的西元 2100 年 1 月 1 號：</p>
<div class="highlight"><pre><span></span><span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'owner'</span><span class="p">:</span> <span class="s1">'Meng Lee'</span><span class="p">,</span>
    <span class="s1">'start_date'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">'schedule_interval'</span><span class="p">:</span> <span class="s1">'@daily'</span><span class="p">,</span>
    <span class="o">...</span>

<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="s1">'comic_app_v2'</span><span class="p">,</span> <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
<p>作者目前撰寫這篇文章的日期為西元 2018 年 8 月 20 號，大概還要等到 82 年</p>
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/scheduled-dags.png" style="width:90%"/>
<br/>
</center>
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/success-dag.png" style="width:90%"/>
<br/>
</center>
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/three-slack-messages.png" style="width:90%"/>
<br/>
</center>
<center>
<img src="https://leemengtaiwan.github.io/images/airflow/success-dags.png" style="width:90%"/>
<br/>
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">![](</span>scheduled-dags.png<span class="o">)</span>

<span class="n">取那麼大的時間是為了怕之後的讀者在一開啟</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img alt="" src="success-dag.png"/></p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">![](</span>dag-never-end-because-of-absence-of-scheduler.png<span class="o">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img alt="" src="three-slack-messages.png"/></p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">![](</span>success-dags.png<span class="o">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="App-版本三：填填樂_1">App 版本三：填填樂<a class="anchor-link" href="#App-版本三：填填樂">&para;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>到目前為止你應該已經非常熟悉 airflow 工作的開發以經排程</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="自動化的核心：Selenium">自動化的核心：Selenium<a class="anchor-link" href="#自動化的核心：Selenium">&para;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="工作之間的訊息交換">工作之間的訊息交換<a class="anchor-link" href="#工作之間的訊息交換">&para;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="實作一個閱讀紀錄">實作一個閱讀紀錄<a class="anchor-link" href="#實作一個閱讀紀錄">&para;</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="err">&mdash;</span><span class="o">-</span>
<span class="n">一步步開發</span> <span class="n">app</span><span class="p">,</span> <span class="n">iteration</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>

<span class="n">從只有一個</span> <span class="n">dummy</span> <span class="n">task</span><span class="p">(</span><span class="n">do</span> <span class="n">everything</span> <span class="n">here</span><span class="o">!)</span> 的 一個 dag 開始
<span class="n">介紹</span> <span class="n">dag</span>
<span class="n">測試單一</span> <span class="n">task</span> 
<span class="n">測試整個</span> <span class="n">dag</span> 

<span class="n">加所有dummy</span>  <span class="n">task</span><span class="err">，</span> <span class="n">設定整個</span> <span class="n">dependencies</span> 
<span class="n">介紹</span> <span class="n">xcom</span> 
<span class="n">測試整個</span> <span class="n">dag</span>

<span class="n">實際加功能進去</span>
<span class="n">分每個</span> <span class="n">function</span> <span class="n">介紹</span>

<span class="n">事後監控</span>

<span class="n">看漫畫</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="為何要-Airflow？_2">為何要 Airflow？<a class="anchor-link" href="#為何要-Airflow？">&para;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Why</span> <span class="n">bother</span> airflow<span class="o">?</span>
<span class="n">你想要做的是資料處理</span><span class="err">，</span><span class="n">而不是建立</span> <span class="n">ＷＭＳ</span>
<span class="o">*</span> <span class="n">Why</span> <span class="ow">not</span> <span class="n">python</span> <span class="n">script</span><span class="err">?</span> <span class="n">墨菲定律</span><span class="err">，</span> <span class="n">Retry</span> <span class="n">automatically</span>
<span class="o">*</span> <span class="n">Schedule</span><span class="p">:</span> <span class="n">Corn</span> <span class="n">possible</span><span class="p">,</span> <span class="n">but</span> <span class="n">dependencies</span> <span class="n">難以管理</span>
<span class="o">*</span> <span class="n">why</span> <span class="n">airflow</span> <span class="ow">not</span> <span class="n">Azakaban</span><span class="err">?</span> <span class="n">Apache</span> <span class="n">incubator</span> <span class="err">，</span><span class="n">簡單</span> <span class="n">UI</span>

<span class="n">在我們的漫畫</span> <span class="n">case</span> <span class="n">中</span> <span class="n">airflow</span> <span class="n">是一個</span> <span class="n">overkill</span><span class="p">,</span> <span class="n">但這篇文章希望透過go</span> <span class="n">though</span> <span class="n">這個問題讓讀者熟悉</span> <span class="n">airflow</span> <span class="n">的運作</span><span class="err">，</span><span class="n">為解決企業等級的問題做好準備</span><span class="err">。</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="結語">結語<a class="anchor-link" href="#結語">&para;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>感謝。</p>
<p>就是因為是我希望當初學的時候有人寫給我的書，所以初學者會有的疑問你都可以在裡面找到解答。</p>
<p>冰山一角（iceberg 圖片）</p>
<p>一本關於 Airflow 的輕小說。本文透過大量對話，以及實際操作畫面，讓完全沒有接觸過資料工程或者 Airflow 的讀者在跟著實現一個漫畫連載 App 的過程中逐漸掌握 Airflow 的精神</p>
<p>輕小說：</p>
<ul>
<li>長度比一般技術文章長太多</li>
<li>平易近人，不艱澀難懂</li>
</ul>
<p>將章節傳送門的介紹設定為「toc 螢幕截圖」，推薦讀者閱讀</p>
<p>你甚至也可以選擇時用其它語言 (e.g., JAVA)</p>
<p>this app is batch-based, not realtime, which is not a fit for airflow</p>
<p>期望在讀者們能在閱讀文章之後實際應用 Airflow 來解決自己以及企業的問題。</p>
<p>「你也可以推薦漫畫給我」
不過老實說，我偶爾還是習慣動作會去檢查新的漫畫出來了沒。</p>
<ul>
<li>結語： 你想自動化什麼？ implement it and tell me! </li>
</ul>
<p>之後將在奇幻旅程 2 提到我在 SmartNews 裡頭是怎麼使用 Airflow 的，歡迎訂閱</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="繼續探索-/-前往專精之路">繼續探索 / 前往專精之路<a class="anchor-link" href="#繼續探索-/-前往專精之路">&para;</a></h2><p>references</p>
<p>要求資料工程的人來 review, 這次一篇給台灣人看的 Airflow 入門文章。</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">再舉個執行日期的例子</span><span class="err">。</span>

<span class="n">還記得我們當初在測試單一一個</span> <span class="n">Airflow</span> <span class="n">工作的指令嗎</span><span class="err">？</span><span class="n">比方說當初我們測試</span> <span class="err">`</span><span class="n">comic_app_v2</span><span class="err">`</span> <span class="n">DAG</span> <span class="n">裡頭的</span> <span class="err">`</span><span class="n">get_read_history</span><span class="err">`</span> <span class="n">工作</span><span class="err">：</span>

<span class="err">```</span><span class="n">bash</span>
<span class="n">airflow</span> <span class="n">test</span> <span class="n">comic_app_v2</span> <span class="n">get_read_history</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>
<span class="err">```</span>

<span class="n">這邊的</span> <span class="err">`</span><span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="err">`</span> <span class="n">就是所謂的執行日期</span><span class="err">（</span><span class="n">execute_date</span><span class="err">），</span><span class="n">代表我們想要測試當執行日期為</span> <span class="err">`</span><span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="err">`</span> <span class="n">的時候</span><span class="err">，`</span><span class="n">get_read_history</span><span class="err">`</span> <span class="n">工作的執行結果會是什麼</span><span class="err">。</span><span class="n">雖然該工作裡頭沒有取用</span> <span class="err">`</span><span class="n">ds</span><span class="err">`</span> <span class="n">變數</span><span class="err">，</span><span class="n">但假如你在該工作裡頭</span> <span class="err">`</span><span class="nb">print</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span><span class="err">`，</span><span class="n">就會得到</span> <span class="err">`</span><span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="err">`。</span>
</pre></div>
</div>
</div>
</div>
</div>


                <!-- Tags -->
                <p class="blog-content__tags">
                    <span>Post Tags</span>

                    <span class="blog-content__tag-list">
                        <a href="https://leemengtaiwan.github.io/tag/python.html" rel="tag">Python</a>
                        <a href="https://leemengtaiwan.github.io/tag/airflow.html" rel="tag">Airflow</a>
                        <a href="https://leemengtaiwan.github.io/tag/zi-liao-gong-cheng.html" rel="tag">資料工程</a>
                        <a href="https://leemengtaiwan.github.io/tag/selenium.html" rel="tag">Selenium</a>
                        <a href="https://leemengtaiwan.github.io/tag/slack.html" rel="tag">Slack</a>
                    </span>

                </p>

















































                <!-- end Tags -->


                <!-- Mail-list-subscribe -->
                <div id="article-inner-subscribe" class="blog-content__pagenav">
                    <div class="blog-content__nav">
                        <div class="blog-content__prev">
                            <a class="open-popup" rel="subscribe">
                                <span>Get Latest Arrivals</span>
                                訂閱最新文章
                            </a>
                        </div>
                        <div class="blog-content__next">
                            <p>
                                跟資料科學相關的最新文章直接送到家。</br>
                                只要加入訂閱名單，當新文章出爐時，</br>
                                你將能馬上收到通知 <i class="im im-newspaper-o" aria-hidden="true"></i>
                            </p>
                        </div>
                    </div>
                    <div class="blog-content__all">
                        <a class="open-popup btn btn--primary " style="color: #FFFFFF">&nbsp;&nbsp;Subscribe&nbsp;&nbsp;&nbsp;</a>
                    </div>
                </div>
                <!-- end Mail-list-subscribe -->

                <!--Pagination-->
                <div id="article-inner-neighbor-pages" class="blog-content__pagenav">
                    <div class="blog-content__nav">
                    </div>

                    <div class="blog-content__all">
                        <a href="blog.html" class="btn btn--primary">
                            View All Post
                        </a>
                    </div>
                </div>
                <!-- end Pagination-->

            </div><!-- end blog-content__main -->


        </div>
        </div> <!-- end blog-content -->

    </article>

<div class="comments-wrap">
    <div id="comments" class="row">
        <div class="col-full">
            <div id="disqus_thread"></div>
        </div>
    </div>
</div>

<script type="text/javascript">
var disqus_shortname = 'leemengtaiwan';
var disqus_title = '如何用 Python 追漫畫連載 - Airflow 從零到專精之路';

(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    <!-- footer
    ================================================== -->
    <footer>
        <div class="row">
            <div class="col-full">

                <div class="footer-logo">
                    <a class="footer-site-logo" href="#0"><img src="https://leemengtaiwan.github.io/theme/images/logo.png" alt="Homepage"></a>
                </div>

                <ul class="footer-social">
<li><a href="https://github.com/leemengtaiwan" target="_blank">
    <i class="im im-github" aria-hidden="true"></i>
    <span>Github</span>
</a></li>
<li><a href="https://www.facebook.com/LeeMengTaiwan" target="_blank">
    <i class="im im-facebook" aria-hidden="true"></i>
    <span>Facebook</span>
</a></li>
<li><a href="https://www.instagram.com/leemengtaiwan/" target="_blank">
    <i class="im im-instagram" aria-hidden="true"></i>
    <span>Instagram</span>
</a></li>
<li><a href="https://www.linkedin.com/in/leemeng1990/" target="_blank">
    <i class="im im-linkedin" aria-hidden="true"></i>
    <span>LinkedIn</span>
</a></li>                </ul>
            </div>
        </div>

        <div class="row footer-bottom">
            <div class="col-twelve">
                <div class="copyright">
                    <span>Powered by <a href="http://getpelican.com/" target="_blank">Pelican</a></span>
                    <span>© Copyright Hola 2017</span>
                    <span>Design by <a href="https://www.styleshout.com/" target="_blank">styleshout</a></span>
                </div>

                <div class="go-top">
                <a class="smoothscroll" title="Back to Top" href="#top"><i class="im im-arrow-up" aria-hidden="true"></i></a>
                </div>
            </div>
        </div> <!-- end footer-bottom -->
    </footer> <!-- end footer -->


    <div id="preloader">
        <div id="loader"></div>
    </div>

        <!-- Javascript
    ================================================== -->
    <script src="https://leemengtaiwan.github.io/theme/js/jquery-3.2.1.min.js"></script>
    <script src="https://leemengtaiwan.github.io/theme/js/plugins.js"></script>
    <script src="https://leemengtaiwan.github.io/theme/js/main.js"></script>

    <script type='text/javascript' src='https://leemengtaiwan.github.io/theme/js/progress-bar.js'></script>
    <script type='text/javascript' src='https://leemengtaiwan.github.io/theme/js/scroll-detect.js'></script>

    <!--show and hide left navigation by scrolling-->
    <script>
    $(document).scroll(function() {
        var y = $(this).scrollTop();
      if ( $(window).width() > 980 ) {
        if (y > 600) {
          $('#left-navigation').fadeIn(300);
        } else {
          $('#left-navigation').fadeOut(300);
        }
      }
    });
    </script>

<!--reference: https://gist.github.com/scottmagdalein/259d878ad46ed6f2cdce-->
<script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/embed.js" data-dojo-config="usePlainJson: true, isDebug: false">
</script>

<script type="text/javascript">
  function showMailingPopUp() {
    require(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us18.list-manage.com","uuid":"151cb59f2de814c499c76b77a","lid":"dd1d78cc5e"})})
    document.cookie = "MCPopupClosed=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
    document.cookie = "MCPopupSubscribed=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
  };

  $(function() {
    $(".open-popup").on('click', function() {
      showMailingPopUp();
    });
  });
</script>
<!--reference: https://www.w3schools.com/howto/tryit.asp?filename=tryhow_js_overlay-->
<script>
function openTocNav() {
    document.getElementById("tocNav").style.width = "100%";
}

function closeTocNav() {
    document.getElementById("tocNav").style.width = "0%";
}

function toggleTovNav() {
    var current_width = document.getElementById("tocNav").style.width;
    if (current_width == "100%") {
        document.getElementById("tocNav").style.width = "0%";
    } else {
        document.getElementById("tocNav").style.width = "100%";
    }
}
</script>


</body>
</html>